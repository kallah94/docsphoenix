<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.21.2">
    <meta name="project" content="Phoenix v1.4.15">
    <title>Testing Controllers â€” Phoenix v1.4.15</title>
    <link rel="stylesheet" href="dist/html-de2388dc2f8074b0a4db.css" />
    <script src="dist/sidebar_items-c08200cd71.js"></script>
      <script src="docs_config.js"></script>
    <script async src="dist/html-de2388dc2f8074b0a4db.js"></script>
  </head>
  <body data-type="extras">
    <script>try { if(localStorage.getItem('night-mode') === 'true') document.body.className += ' night-mode'; } catch (e) { }</script>
<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button">
      <span class="icon-cross" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" id="search-list" class="search-input" placeholder="Search..." aria-label="Search" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="http://www.phoenixframework.org" class="sidebar-projectName">
Phoenix      </a>
      <h2 class="sidebar-projectVersion">
        v1.4.15
      </h2>
    </div>
      <a href="http://www.phoenixframework.org">
        <img src="assets/logo.png" alt="Phoenix" class="sidebar-projectImage">
      </a>
  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">GUIDES</a></li>

      <li><a id="modules-list" href="#full-list">Modules</a></li>

      <li><a id="exceptions-list" href="#full-list">Exceptions</a></li>

      <li><a id="tasks-list" href="#full-list">Mix Tasks</a></li>
  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>Testing Controllers</h1>
<p>We&#39;re going to take a look at how we might test drive a controller which has endpoints for a JSON api.</p>
<p>Phoenix has a generator for creating a JSON resource which looks like this:</p>
<pre><code class="console">$ mix phx.gen.json  AllTheThings Thing things some_attr:string another_attr:string</code></pre>
<p>In this command, AllTheThings is the context; Thing is the schema; things is the plural name of the schema (which is used as the table name). Then <code class="inline">some_attr</code> and <code class="inline">another_attr</code> are the database columns on table <code class="inline">things</code> of type string.</p>
<p>However, <em>don&#39;t</em> actually run this command. Instead, we&#39;re going to explore test driving out a similar result to what a generator would give us.</p>
<h3 id="set-up" class="section-heading">
  <a href="#set-up" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Set up
</h3>

<p>If you haven&#39;t already done so, first create a blank project by running:</p>
<pre><code class="console">$ mix phx.new hello</code></pre>
<p>Change into the newly-created <code class="inline">hello</code> directory, configure your database in <code class="inline">config/dev.exs</code> and then run:</p>
<pre><code class="console">$ mix ecto.create</code></pre>
<p>If you have any questions about this process, now is a good time to jump over to the <a href="up_and_running.html">Up and Running Guide</a>.</p>
<p>Let&#39;s create an <code class="inline">Accounts</code> context for this example. Since context creation is not in scope of this guide, we will use the generator. If you aren&#39;t familiar, read <a href="phoenix_mix_tasks.html#phoenix-specific-mix-tasks">this section of the Mix guide</a> and <a href="contexts.html#content">the Contexts Guide</a>.</p>
<pre><code class="console">$ mix phx.gen.context Accounts User users name:string email:string:unique password:string

* creating lib/hello/accounts/user.ex
* creating priv/repo/migrations/20170913155721_create_users.exs
* creating lib/hello/accounts.ex
* injecting lib/hello/accounts.ex
* creating test/hello/accounts/accounts_test.exs
* injecting test/hello/accounts/accounts_test.exs

Remember to update your repository by running migrations:

    $ mix ecto.migrate</code></pre>
<p>Ordinarily we would spend time tweaking the generated migration file (<code class="inline">priv/repo/migrations/&lt;datetime&gt;_create_users.exs</code>) to add things like non-null constraints and so on, but we don&#39;t need to make any changes for this example, so we can just run the migration:</p>
<pre><code class="console">$ mix ecto.migrate
Compiling 2 files (.ex)
Generated hello app
[info] == Running Hello.Repo.Migrations.CreateUsers.change/0 forward
[info] create table users
[info] create index users_email_index
[info] == Migrated in 0.0s</code></pre>
<p>As a final check before we start developing, we can run <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a> and make sure that all is well.</p>
<pre><code class="console">$ mix test</code></pre>
<p>All of the tests should pass, but sometimes the database isn&#39;t configured properly in <code class="inline">config/test.exs</code>, or some other issue crops up. It is best to correct these issues now, <em>before</em> we complicate things with deliberately breaking tests!</p>
<h3 id="test-driving" class="section-heading">
  <a href="#test-driving" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Test driving
</h3>

<p>What we are going for is a controller with the standard CRUD actions. We&#39;ll start with our test since we&#39;re TDDing this. Create a <code class="inline">user_controller_test.exs</code> file in <code class="inline">test/hello_web/controllers</code></p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserControllerTest</span><span class="w"> </span><span class="k" data-group-id="9257382186-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="w">

</span><span class="k" data-group-id="9257382186-1">end</span></code></pre>
<p>There are many ways to approach TDD. Here, we will think about each action we want to perform, and handle the &quot;happy path&quot; where things go as planned, and the error case where something goes wrong, if applicable.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserControllerTest</span><span class="w"> </span><span class="k" data-group-id="6272510032-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;index/2 responds with all Users&quot;</span><span class="w">

  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;create/2&quot;</span><span class="w"> </span><span class="k" data-group-id="6272510032-2">do</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Creates, and responds with a newly created user if attributes are valid&quot;</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Returns an error and does not create a user if attributes are invalid&quot;</span><span class="w">
  </span><span class="k" data-group-id="6272510032-2">end</span><span class="w">

  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;show/2&quot;</span><span class="w"> </span><span class="k" data-group-id="6272510032-3">do</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with user info if the user is found&quot;</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with a message indicating user not found&quot;</span><span class="w">
  </span><span class="k" data-group-id="6272510032-3">end</span><span class="w">

  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;update/2&quot;</span><span class="w"> </span><span class="k" data-group-id="6272510032-4">do</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Edits, and responds with the user if attributes are valid&quot;</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Returns an error and does not edit the user if attributes are invalid&quot;</span><span class="w">
  </span><span class="k" data-group-id="6272510032-4">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;delete/2 and responds with :ok if the user was deleted&quot;</span><span class="w">

</span><span class="k" data-group-id="6272510032-1">end</span></code></pre>
<p>Here we have tests around the 5 controller CRUD actions we need to implement for a typical JSON API. At the top of the module we are using the module <code class="inline">HelloWeb.ConnCase</code>, which provides connections to our test repository. Then we define the 8 tests. In 2 cases, index and delete, we are only testing the happy path, because in our case they generally won&#39;t fail because of domain rules (or lack thereof). In practical application, our delete could fail easily once we have associated resources that cannot leave orphaned resources behind, or number of other situations. On index, we could have filtering and searching to test. Also, both could require authorization.</p>
<p>Create, show and update have more typical ways to fail because they need a way to find the resource, which could be non existent, or invalid data was supplied in the params. Since we have multiple tests for each of these endpoints, putting them in a <code class="inline">describe</code> block is good way to organize our tests.</p>
<p>Let&#39;s run the test:</p>
<pre><code class="console">$ mix test test/hello_web/controllers/user_controller_test.exs</code></pre>
<p>We get 8 failures that say &quot;Not implemented&quot; which is good. Our tests don&#39;t have blocks yet.</p>
<h3 id="the-first-test" class="section-heading">
  <a href="#the-first-test" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  The first test
</h3>

<p>Let&#39;s add our first test. We&#39;ll start with <code class="inline">index/2</code>.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserControllerTest</span><span class="w"> </span><span class="k" data-group-id="7143985051-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb.ConnCase</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;index/2 responds with all Users&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7143985051-2">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="7143985051-2">}</span><span class="w"> </span><span class="k" data-group-id="7143985051-3">do</span><span class="w">

    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7143985051-4">[</span><span class="p" data-group-id="7143985051-5">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;john@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;john pass&quot;</span><span class="p" data-group-id="7143985051-5">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="7143985051-6">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Jane&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jane@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jane pass&quot;</span><span class="p" data-group-id="7143985051-6">}</span><span class="p" data-group-id="7143985051-4">]</span><span class="w">

    </span><span class="c1"># create users local to this database connection and test</span><span class="w">
    </span><span class="p" data-group-id="7143985051-7">[</span><span class="p" data-group-id="7143985051-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user1</span><span class="p" data-group-id="7143985051-8">}</span><span class="p">,</span><span class="p" data-group-id="7143985051-9">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user2</span><span class="p" data-group-id="7143985051-9">}</span><span class="p" data-group-id="7143985051-7">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="7143985051-10">(</span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">Accounts</span><span class="o">.</span><span class="n">create_user</span><span class="p" data-group-id="7143985051-11">(</span><span class="ni">&amp;1</span><span class="p" data-group-id="7143985051-11">)</span><span class="p" data-group-id="7143985051-10">)</span><span class="w">

    </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="7143985051-12">(</span><span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p" data-group-id="7143985051-13">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="7143985051-13">)</span><span class="p" data-group-id="7143985051-12">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">json_response</span><span class="p" data-group-id="7143985051-14">(</span><span class="mi">200</span><span class="p" data-group-id="7143985051-14">)</span><span class="w">

    </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7143985051-15">%{</span><span class="w">
      </span><span class="s">&quot;data&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="p" data-group-id="7143985051-16">[</span><span class="w">
        </span><span class="p" data-group-id="7143985051-17">%{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user1</span><span class="o">.</span><span class="n">email</span><span class="w"> </span><span class="p" data-group-id="7143985051-17">}</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="7143985051-18">%{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user2</span><span class="o">.</span><span class="n">email</span><span class="w"> </span><span class="p" data-group-id="7143985051-18">}</span><span class="w">
      </span><span class="p" data-group-id="7143985051-16">]</span><span class="w">
    </span><span class="p" data-group-id="7143985051-15">}</span><span class="w">

    </span><span class="n">assert</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="w">
  </span><span class="k" data-group-id="7143985051-3">end</span></code></pre>
<p>Let&#39;s take a look at what&#39;s going on here. First we alias <code class="inline">Hello.Accounts</code>, the context module that provides us with our repository manipulation functions. When we use the <code class="inline">HelloWeb.ConnCase</code> module, it sets things up such that each connection is wrapped in a transaction, <em>and</em> all of the database interactions inside of the test use the same database connection and transaction. This module also sets up a <code class="inline">conn</code> attribute in our ExUnit context, using <code class="inline">Phoenix.ConnCase.build_conn/0</code>. We then pattern match this to use it in each test case. For details, take a look at the file <code class="inline">test/support/conn_case.ex</code>, as well as the <a href="https://hexdocs.pm/ecto_sql/Ecto.Adapters.SQL.Sandbox.html">Ecto documentation for SQL.Sandbox</a>. We could put a <code class="inline">build_conn/0</code> call inside of each test, but it is cleaner to use a setup block to do it.</p>
<p>The index test then hooks into the context to extract the contents of the <code class="inline">:conn</code> key. We then create two users using the <code class="inline">Hello.Accounts.create_user/1</code> function. Again, note that this function accesses the test repo, but even though we don&#39;t pass the <code class="inline">conn</code> variable to the call, it still uses the same connection and puts these new users inside the same database transaction. Next the <code class="inline">conn</code> is piped to a <code class="inline">get</code> function to make a <code class="inline">GET</code> request to our <code class="inline">UserController</code> index action, which is in turn piped into <code class="inline">json_response/2</code> along with the expected HTTP status code. This will return the JSON from the response body, when everything is wired up properly. We represent the JSON we want the controller action to return with the variable <code class="inline">expected</code>, and assert that the <code class="inline">response</code> and <code class="inline">expected</code> are the same.</p>
<p>Our expected data is a JSON response with a top level key of <code class="inline">&quot;data&quot;</code> containing an array of users that have <code class="inline">&quot;name&quot;</code> and <code class="inline">&quot;email&quot;</code> properties that should match the users created before making the request. Also, we do not want the users&#39; &quot;password&quot; properties to show up in our JSON response.</p>
<p>When we run the test we get an error that we have no <code class="inline">user_path</code> function.</p>
<p>In our router, we&#39;ll uncomment the <code class="inline">api</code> scope at the bottom of the auto-generated file, and then use the resources macro to generate the routes for the &quot;/users&quot; path. Because we aren&#39;t going to be generating forms to create and update users, we add the <code class="inline">except: [:new, :edit]</code> to skip those endpoints.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.Router</span><span class="w"> </span><span class="k" data-group-id="9106416807-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:router</span><span class="w">

  </span><span class="n">pipeline</span><span class="w"> </span><span class="ss">:browser</span><span class="w"> </span><span class="k" data-group-id="9106416807-2">do</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:accepts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9106416807-3">[</span><span class="s">&quot;html&quot;</span><span class="p" data-group-id="9106416807-3">]</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_session</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_flash</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:protect_from_forgery</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:put_secure_browser_headers</span><span class="w">
  </span><span class="k" data-group-id="9106416807-2">end</span><span class="w">

  </span><span class="n">pipeline</span><span class="w"> </span><span class="ss">:api</span><span class="w"> </span><span class="k" data-group-id="9106416807-4">do</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:accepts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9106416807-5">[</span><span class="s">&quot;json&quot;</span><span class="p" data-group-id="9106416807-5">]</span><span class="w">
  </span><span class="k" data-group-id="9106416807-4">end</span><span class="w">

  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="w"> </span><span class="k" data-group-id="9106416807-6">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span><span class="w">

    </span><span class="n">get</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">PageController</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="w">
  </span><span class="k" data-group-id="9106416807-6">end</span><span class="w">

  </span><span class="c1"># Other scopes may use custom stacks.</span><span class="w">
  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="w"> </span><span class="k" data-group-id="9106416807-7">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:api</span><span class="w">
    </span><span class="n">resources</span><span class="w"> </span><span class="s">&quot;/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">UserController</span><span class="p">,</span><span class="w"> </span><span class="ss">except</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9106416807-8">[</span><span class="ss">:new</span><span class="p">,</span><span class="w"> </span><span class="ss">:edit</span><span class="p" data-group-id="9106416807-8">]</span><span class="w">
  </span><span class="k" data-group-id="9106416807-7">end</span><span class="w">
</span><span class="k" data-group-id="9106416807-1">end</span></code></pre>
<p>Before running the test again, check out our new paths by running <a href="Mix.Tasks.Phx.Routes.html"><code class="inline">mix phx.routes</code></a>. You should see six new &quot;/api&quot; routes in addition to the default page controller route:</p>
<pre><code class="console">$ mix phx.routes
Compiling 6 files (.ex)
page_path  GET     /               HelloWeb.PageController :index
user_path  GET     /api/users      HelloWeb.UserController :index
user_path  GET     /api/users/:id  HelloWeb.UserController :show
user_path  POST    /api/users      HelloWeb.UserController :create
user_path  PATCH   /api/users/:id  HelloWeb.UserController :update
           PUT     /api/users/:id  HelloWeb.UserController :update
user_path  DELETE  /api/users/:id  HelloWeb.UserController :delete</code></pre>
<p>We should get a new error now. Running the test informs us we don&#39;t have a <code class="inline">HelloWeb.UserController</code>. Let&#39;s create that controller by opening the file <code class="inline">lib/hello_web/controllers/user_controller.ex</code> and adding the <code class="inline">index/2</code> action we&#39;re testing. Our test description has us returning all users:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserController</span><span class="w"> </span><span class="k" data-group-id="1362557527-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">index</span><span class="p" data-group-id="1362557527-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="1362557527-2">)</span><span class="w"> </span><span class="k" data-group-id="1362557527-3">do</span><span class="w">
    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">list_users</span><span class="p" data-group-id="1362557527-4">(</span><span class="p" data-group-id="1362557527-4">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="1362557527-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;index.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">users</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="1362557527-5">)</span><span class="w">
  </span><span class="k" data-group-id="1362557527-3">end</span><span class="w">

</span><span class="k" data-group-id="1362557527-1">end</span></code></pre>
<p>When we run the test again, our failing test tells us the module <code class="inline">HelloWeb.UserView</code> is not available. Let&#39;s add it by creating the file <code class="inline">lib/hello_web/views/user_view.ex</code>. Our test specifies a JSON format with a top key of <code class="inline">&quot;data&quot;</code>, containing an array of users with attributes <code class="inline">&quot;name&quot;</code> and <code class="inline">&quot;email&quot;</code>.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserView</span><span class="w"> </span><span class="k" data-group-id="7812115084-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:view</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="7812115084-2">(</span><span class="s">&quot;index.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7812115084-3">%{</span><span class="ss">users</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="7812115084-3">}</span><span class="p" data-group-id="7812115084-2">)</span><span class="w"> </span><span class="k" data-group-id="7812115084-4">do</span><span class="w">
    </span><span class="p" data-group-id="7812115084-5">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">render_many</span><span class="p" data-group-id="7812115084-6">(</span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb.UserView</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user.json&quot;</span><span class="p" data-group-id="7812115084-6">)</span><span class="p" data-group-id="7812115084-5">}</span><span class="w">
  </span><span class="k" data-group-id="7812115084-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="7812115084-7">(</span><span class="s">&quot;user.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7812115084-8">%{</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7812115084-8">}</span><span class="p" data-group-id="7812115084-7">)</span><span class="w"> </span><span class="k" data-group-id="7812115084-9">do</span><span class="w">
    </span><span class="p" data-group-id="7812115084-10">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p" data-group-id="7812115084-10">}</span><span class="w">
  </span><span class="k" data-group-id="7812115084-9">end</span><span class="w">

</span><span class="k" data-group-id="7812115084-1">end</span></code></pre>
<p>The view module for the index uses the <code class="inline">render_many/4</code> function. According to the <a href="https://hexdocs.pm/phoenix/Phoenix.View.html#render_many/4">documentation</a>, using <code class="inline">render_many/4</code> is &quot;roughly equivalent&quot; to using <a href="https://hexdocs.pm/elixir/Enum.html#map/2"><code class="inline">Enum.map/2</code></a>, and in fact <code class="inline">Enum.map</code> is called under the hood. The main difference between <code class="inline">render_many/4</code> and directly calling <a href="https://hexdocs.pm/elixir/Enum.html#map/2"><code class="inline">Enum.map/2</code></a> is that the former benefits from library-quality error checking, properly handling missing values, and so on. <code class="inline">render_many/4</code> also has an <code class="inline">:as</code> option that can used so that the key in the assigns map can be renamed. By default, this is inferred from the module name (<code class="inline">:user</code> in this case), but it can be changed if necessary to fit the render function being used.</p>
<p>And with that, our test passes when we run it.</p>
<h3 id="testing-the-show-action" class="section-heading">
  <a href="#testing-the-show-action" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Testing the show action
</h3>

<p>We&#39;ll also cover the <code class="inline">show/2</code> action here so we can see how to handle an error case.</p>
<p>Our show tests currently look like this:</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;show/2&quot;</span><span class="w"> </span><span class="k" data-group-id="7760346418-1">do</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with user info if the user is found&quot;</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with a message indicating user not found&quot;</span><span class="w">
  </span><span class="k" data-group-id="7760346418-1">end</span></code></pre>
<p>Run this test only by running the following command: (if your show tests don&#39;t start on line 34, change the line number accordingly)</p>
<pre><code class="console">$ mix test test/hello_web/controllers/user_controller_test.exs:34</code></pre>
<p>Our first <code class="inline">show/2</code> test result is, as expected, not implemented. Let&#39;s build a test around what we think a successful <code class="inline">show/2</code> should look like.</p>
<pre><code class="nohighlight makeup elixir"><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with user info if the user is found&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0320297076-1">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="0320297076-1">}</span><span class="w"> </span><span class="k" data-group-id="0320297076-2">do</span><span class="w">
  </span><span class="p" data-group-id="0320297076-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="0320297076-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">create_user</span><span class="p" data-group-id="0320297076-4">(</span><span class="p" data-group-id="0320297076-5">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;john@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;john pass&quot;</span><span class="p" data-group-id="0320297076-5">}</span><span class="p" data-group-id="0320297076-4">)</span><span class="w">

  </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="n">conn</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="0320297076-6">(</span><span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p" data-group-id="0320297076-7">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="0320297076-7">)</span><span class="p" data-group-id="0320297076-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">json_response</span><span class="p" data-group-id="0320297076-8">(</span><span class="mi">200</span><span class="p" data-group-id="0320297076-8">)</span><span class="w">

  </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0320297076-9">%{</span><span class="s">&quot;data&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="p" data-group-id="0320297076-10">%{</span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p" data-group-id="0320297076-10">}</span><span class="p" data-group-id="0320297076-9">}</span><span class="w">

  </span><span class="n">assert</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="w">
</span><span class="k" data-group-id="0320297076-2">end</span></code></pre>
<p>This is fine, but it can be refactored slightly. Notice that both this test and the index test need users in the database. Instead of creating these users over and over again, we can instead call another <code class="inline">setup/1</code> function to populate the database with users on an as-needed basis. To do this, first create a private function at the bottom of the test module as follows:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defp</span><span class="w"> </span><span class="nf">create_user</span><span class="p" data-group-id="8274082379-1">(</span><span class="bp">_</span><span class="p" data-group-id="8274082379-1">)</span><span class="w"> </span><span class="k" data-group-id="8274082379-2">do</span><span class="w">
  </span><span class="p" data-group-id="8274082379-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="8274082379-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">create_user</span><span class="p" data-group-id="8274082379-4">(</span><span class="na">@create_attrs</span><span class="p" data-group-id="8274082379-4">)</span><span class="w">
  </span><span class="p" data-group-id="8274082379-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="8274082379-5">}</span><span class="w">
</span><span class="k" data-group-id="8274082379-2">end</span></code></pre>
<p>Next define <code class="inline">@create_attrs</code> as a custom attribute for the module at the top, as follows.</p>
<pre><code class="nohighlight makeup elixir"><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">

</span><span class="na">@create_attrs</span><span class="w"> </span><span class="p" data-group-id="1448158857-1">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;john@example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;john pass&quot;</span><span class="p" data-group-id="1448158857-1">}</span></code></pre>
<p>Finally, invoke the function using a second <code class="inline">setup/1</code> call inside of the <code class="inline">describe</code> block:</p>
<pre><code class="nohighlight makeup elixir"><span class="n">describe</span><span class="w"> </span><span class="s">&quot;show/2&quot;</span><span class="w"> </span><span class="k" data-group-id="6256777838-1">do</span><span class="w">
  </span><span class="n">setup</span><span class="w"> </span><span class="p" data-group-id="6256777838-2">[</span><span class="ss">:create_user</span><span class="p" data-group-id="6256777838-2">]</span><span class="w">
  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with user info if the user is found&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6256777838-3">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="6256777838-3">}</span><span class="w"> </span><span class="k" data-group-id="6256777838-4">do</span><span class="w">

    </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="6256777838-5">(</span><span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p" data-group-id="6256777838-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="6256777838-6">)</span><span class="p" data-group-id="6256777838-5">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">json_response</span><span class="p" data-group-id="6256777838-7">(</span><span class="mi">200</span><span class="p" data-group-id="6256777838-7">)</span><span class="w">

    </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6256777838-8">%{</span><span class="s">&quot;data&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="p" data-group-id="6256777838-9">%{</span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p" data-group-id="6256777838-9">}</span><span class="p" data-group-id="6256777838-8">}</span><span class="w">

    </span><span class="n">assert</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="w">
  </span><span class="k" data-group-id="6256777838-4">end</span><span class="w">
  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with a message indicating user not found&quot;</span><span class="w">
</span><span class="k" data-group-id="6256777838-1">end</span></code></pre>
<p>The functions called by <code class="inline">setup</code> take an ExUnit context (not to be confused with the contexts we are describing throughout this guide) and allow us to add additional fields when we return. In this case, <code class="inline">create_user</code> doesn&#39;t care about the existing context (hence the underscore parameter), and adds a new user to the ExUnit context under the key <code class="inline">user:</code>  by returning <code class="inline">{:ok, user: user}</code>. The test can then access both the database connection and this new user from the ExUnit context.</p>
<p>Finally, let&#39;s change our <code class="inline">index/2</code> test to also use the new <code class="inline">create_user</code> function. The index test doesn&#39;t <em>really</em> need two users, after all. The revised <code class="inline">index/2</code> test should look like this:</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="n">describe</span><span class="w"> </span><span class="s">&quot;index/2&quot;</span><span class="w"> </span><span class="k" data-group-id="6727118892-1">do</span><span class="w">
    </span><span class="n">setup</span><span class="w"> </span><span class="p" data-group-id="6727118892-2">[</span><span class="ss">:create_user</span><span class="p" data-group-id="6727118892-2">]</span><span class="w">
    </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;index/2 responds with all Users&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6727118892-3">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w"> </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="6727118892-3">}</span><span class="w"> </span><span class="k" data-group-id="6727118892-4">do</span><span class="w">

      </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="6727118892-5">(</span><span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p" data-group-id="6727118892-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="6727118892-6">)</span><span class="p" data-group-id="6727118892-5">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">json_response</span><span class="p" data-group-id="6727118892-7">(</span><span class="mi">200</span><span class="p" data-group-id="6727118892-7">)</span><span class="w">

      </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6727118892-8">%{</span><span class="s">&quot;data&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="p" data-group-id="6727118892-9">[</span><span class="p" data-group-id="6727118892-10">%{</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p" data-group-id="6727118892-10">}</span><span class="p" data-group-id="6727118892-9">]</span><span class="p" data-group-id="6727118892-8">}</span><span class="w">

      </span><span class="n">assert</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="w">
    </span><span class="k" data-group-id="6727118892-4">end</span><span class="w">
  </span><span class="k" data-group-id="6727118892-1">end</span></code></pre>
<p>The biggest change here is that we now wrapped the old test inside of another <code class="inline">describe</code> block so that we have somewhere to put the <code class="inline">setup/2</code> call for the index test. We are now accessing the user from the ExUnit context, and expecting just a single user from the <code class="inline">index/2</code> test results, not two.</p>
<p>The <code class="inline">index/2</code> test should still pass, but the <code class="inline">show/2</code> test will error with a message that we need a <code class="inline">HelloWeb.UserController.show/2</code> action. Let&#39;s add that to the UserController module next.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserController</span><span class="w"> </span><span class="k" data-group-id="3847235819-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Hello.Accounts</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">index</span><span class="p" data-group-id="3847235819-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="3847235819-2">)</span><span class="w"> </span><span class="k" data-group-id="3847235819-3">do</span><span class="w">
    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">list_users</span><span class="p" data-group-id="3847235819-4">(</span><span class="p" data-group-id="3847235819-4">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="3847235819-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;index.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">users</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="3847235819-5">)</span><span class="w">
  </span><span class="k" data-group-id="3847235819-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="3847235819-6">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3847235819-7">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="3847235819-7">}</span><span class="p" data-group-id="3847235819-6">)</span><span class="w"> </span><span class="k" data-group-id="3847235819-8">do</span><span class="w">
    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">get_user!</span><span class="p" data-group-id="3847235819-9">(</span><span class="n">id</span><span class="p" data-group-id="3847235819-9">)</span><span class="w">
    </span><span class="n">render</span><span class="p" data-group-id="3847235819-10">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;show.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="3847235819-10">)</span><span class="w">
  </span><span class="k" data-group-id="3847235819-8">end</span><span class="w">

</span><span class="k" data-group-id="3847235819-1">end</span></code></pre>
<p>You might notice the exclamation point in the <code class="inline">get_user!/1</code> function. This convention means that this function will throw an error if the requested user is not found. You&#39;ll also notice that we aren&#39;t properly handling the possibility of a thrown error here. When we TDD we only want to write enough code to make the test pass. We&#39;ll add more code when we get to the error handling test for <code class="inline">show/2</code>.</p>
<p>Running the test tells us we need a <code class="inline">render/2</code> function that can pattern match on <code class="inline">&quot;show.json&quot;</code>:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HelloWeb.UserView</span><span class="w"> </span><span class="k" data-group-id="0416309224-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">HelloWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:view</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="0416309224-2">(</span><span class="s">&quot;index.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0416309224-3">%{</span><span class="ss">users</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="0416309224-3">}</span><span class="p" data-group-id="0416309224-2">)</span><span class="w"> </span><span class="k" data-group-id="0416309224-4">do</span><span class="w">
    </span><span class="p" data-group-id="0416309224-5">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">render_many</span><span class="p" data-group-id="0416309224-6">(</span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb.UserView</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user.json&quot;</span><span class="p" data-group-id="0416309224-6">)</span><span class="p" data-group-id="0416309224-5">}</span><span class="w">
  </span><span class="k" data-group-id="0416309224-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="0416309224-7">(</span><span class="s">&quot;show.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0416309224-8">%{</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="0416309224-8">}</span><span class="p" data-group-id="0416309224-7">)</span><span class="w"> </span><span class="k" data-group-id="0416309224-9">do</span><span class="w">
    </span><span class="p" data-group-id="0416309224-10">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">render_one</span><span class="p" data-group-id="0416309224-11">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="nc">HelloWeb.UserView</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user.json&quot;</span><span class="p" data-group-id="0416309224-11">)</span><span class="p" data-group-id="0416309224-10">}</span><span class="w">
  </span><span class="k" data-group-id="0416309224-9">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="0416309224-12">(</span><span class="s">&quot;user.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0416309224-13">%{</span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="0416309224-13">}</span><span class="p" data-group-id="0416309224-12">)</span><span class="w"> </span><span class="k" data-group-id="0416309224-14">do</span><span class="w">
    </span><span class="p" data-group-id="0416309224-15">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p" data-group-id="0416309224-15">}</span><span class="w">
  </span><span class="k" data-group-id="0416309224-14">end</span><span class="w">

</span><span class="k" data-group-id="0416309224-1">end</span></code></pre>
<p>Notice the &quot;show.json&quot; rendering path uses <code class="inline">render_one/4</code> instead of <code class="inline">render_many/4</code> because it is only rendering a single user, not a list.</p>
<p>When we run the test again, it passes.</p>
<h3 id="show-when-the-user-is-not-found" class="section-heading">
  <a href="#show-when-the-user-is-not-found" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Show when the user is not found
</h3>

<p>The last item we&#39;ll cover is the case where we don&#39;t find a user in <code class="inline">show/2</code>.</p>
<p>Try this one on your own and see what you come up with. One possible solution will be given below.</p>
<p>Walking through our TDD steps, we add a test that supplies a non-existent user id to <code class="inline">user_path</code> which returns a 404 status and an error message. One interesting problem here is how we might define a &quot;non-existent&quot; id. We could just pick a large integer, but who&#39;s to say some future test won&#39;t generate thousands of test users and break our test? Instead of going bigger, we can also go the other way. Database ids tend to start at 1 and increase forever. Negative numbers are perfectly valid integers, and yet never used for database ids. So we&#39;ll pick -1 as our &quot;unobtainable&quot; user id, which <em>should</em> always fail.</p>
<pre><code class="nohighlight makeup elixir"><span class="n">test</span><span class="w"> </span><span class="s">&quot;Responds with a message indicating user not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1027819809-1">%{</span><span class="ss">conn</span><span class="p">:</span><span class="w">  </span><span class="n">conn</span><span class="p" data-group-id="1027819809-1">}</span><span class="w"> </span><span class="k" data-group-id="1027819809-2">do</span><span class="w">
  </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p" data-group-id="1027819809-3">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p" data-group-id="1027819809-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:show</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p" data-group-id="1027819809-4">)</span><span class="p" data-group-id="1027819809-3">)</span><span class="w">

  </span><span class="n">assert</span><span class="w"> </span><span class="n">text_response</span><span class="p" data-group-id="1027819809-5">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="mi">404</span><span class="p" data-group-id="1027819809-5">)</span><span class="w"> </span><span class="o">=~</span><span class="w"> </span><span class="s">&quot;User not found&quot;</span><span class="w">
</span><span class="k" data-group-id="1027819809-2">end</span></code></pre>
<p>We want a HTTP status code of 404 to notify the requester that this resource was not found, as well as an accompanying error message. Notice that we use <a href="https://hexdocs.pm/phoenix/Phoenix.ConnTest.html#text_response/2"><code class="inline">text_response/2</code></a> instead of <a href="https://hexdocs.pm/phoenix/Phoenix.ConnTest.html#json_response/2"><code class="inline">json_response/2</code></a> to assert that the status code is 404 and the response body matches the accompanying error message. You can run this test now to see what happens. You should see that an <code class="inline">Ecto.NoResultsError</code> is thrown, because there is no such user in the database.</p>
<p>Our controller action needs to handle the error thrown by Ecto. We have two choices here. By default, this will be handled by the <a href="https://github.com/phoenixframework/phoenix_ecto">phoenix_ecto</a> library, returning a 404. However if we want to show a custom error message, we can create a new <code class="inline">get_user/1</code> function that does not throw an Ecto error. For this example, we&#39;ll take the second path and implement a new <code class="inline">get_user/1</code> function in the file <code class="inline">lib/hello/accounts.ex</code>, just before the <code class="inline">get_user!/1</code> function:</p>
<pre><code class="nohighlight makeup elixir"><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
Gets a single `%User{}` from the data store where the primary key matches the
given id.

Returns `nil` if no result was found.

## Examples

    iex&gt; get_user(123)
    %User{}

    iex&gt; get_user(456)
    nil

&quot;&quot;&quot;</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p" data-group-id="3144394484-1">(</span><span class="n">id</span><span class="p" data-group-id="3144394484-1">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="3144394484-2">(</span><span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="3144394484-2">)</span></code></pre>
<p>This function is just a thin wrapper around <code class="inline">Ecto.Repo.get/3</code>, and like that function will return either a <code class="inline">%User{}</code> if the user is found, or <code class="inline">nil</code> if not. Next change the <code class="inline">show/2</code> function to use the non-throwing version, and handle the two possible result cases.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="7033681782-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7033681782-2">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="7033681782-2">}</span><span class="p" data-group-id="7033681782-1">)</span><span class="w"> </span><span class="k" data-group-id="7033681782-3">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">Accounts</span><span class="o">.</span><span class="n">get_user</span><span class="p" data-group-id="7033681782-4">(</span><span class="n">id</span><span class="p" data-group-id="7033681782-4">)</span><span class="w"> </span><span class="k" data-group-id="7033681782-5">do</span><span class="w">
    </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_status</span><span class="p" data-group-id="7033681782-6">(</span><span class="ss">:not_found</span><span class="p" data-group-id="7033681782-6">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">text</span><span class="p" data-group-id="7033681782-7">(</span><span class="s">&quot;User not found&quot;</span><span class="p" data-group-id="7033681782-7">)</span><span class="w">

    </span><span class="n">user</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">render</span><span class="p" data-group-id="7033681782-8">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;show.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7033681782-8">)</span><span class="w">
  </span><span class="k" data-group-id="7033681782-5">end</span><span class="w">
</span><span class="k" data-group-id="7033681782-3">end</span></code></pre>
<p>The first branch of the case statement handles the <code class="inline">nil</code> result case. First, we use the <a href="https://hexdocs.pm/plug/Plug.Conn.html#put_status/2"><code class="inline">put_status/2</code></a> function from <a href="https://hexdocs.pm/plug/1.8.3/Plug.Conn.html"><code class="inline">Plug.Conn</code></a> to set the desired error status. The complete list of allowed codes can be found in the <a href="https://hexdocs.pm/plug/Plug.Conn.Status.html">Plug.Conn.Status documentation</a>, where we can see that <code class="inline">:not_found</code> corresponds to our desired &quot;404&quot; status. We then return a text response using <a href="https://hexdocs.pm/phoenix/Phoenix.Controller.html#text/2"><code class="inline">text/2</code></a>.</p>
<p>The second branch of the case statement handles the &quot;happy path&quot; we&#39;ve already covered. Phoenix also allows us to only implement the &quot;happy path&quot; in our action and use <a href="Phoenix.Controller.html#action_fallback/1"><code class="inline">Phoenix.Controller.action_fallback/1</code></a>. This is useful for centralizing your error handling code. You may wish to refactor the show action to use action_fallback as covered in the &quot;Action Fallback&quot; section of the <a href="controllers.html#action-fallback">controllers guide</a>.</p>
<p>With those implemented, our tests pass. </p>
<p>The rest of the controller is left for you to implement as practice. If you are not sure where to begin, it is worth using the Phoenix JSON generator and seeing what tests are automatically generated for you.</p>
<p>Happy testing!</p>
      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.21.2),
          </span>
          <span class="line">
            designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>
  </body>
</html>
